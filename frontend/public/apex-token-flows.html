<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Apex Wealth Advisor - Token Flow Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            color: #0f172a;
        }
        h1 { color: #0f172a; margin-bottom: 8px; }
        h2 { color: #475569; margin-top: 40px; margin-bottom: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .subtitle { color: #64748b; font-size: 14px; margin-bottom: 32px; }
        .diagram-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        .mermaid {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .note {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-size: 14px;
            color: #92400e;
        }
        .key-point {
            background: #f0fdf4;
            border-left: 4px solid #059669;
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 14px;
        }
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; background: #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <h1>Apex Wealth Advisor - Token Flow Diagrams</h1>
    <p class="subtitle">Detailed OAuth/Token Exchange flows for AI Agent security using Okta XAA and Auth0 Token Vault</p>

    <h2>1. Complete Flow Overview</h2>
    <div class="diagram-container">
        <div class="mermaid">
flowchart TB
    subgraph USER["User"]
        U[Financial Advisor]
    end
    
    subgraph OKTA["Okta Cross-App Access XAA"]
        ID["Step 1: ID Token - OIDC Login"]
        JAG["Step 2: ID-JAG Token - RFC 8693"]
        AS["Step 3: Auth Server Token - RFC 7523"]
    end
    
    subgraph AUTH0["Auth0 Token Vault"]
        VA["Step 4: Vault Access Token"]
        FED["Step 5: Federated Token"]
    end
    
    subgraph TARGETS["Target Systems"]
        MCP[Apex Wealth MCP Server]
        GC[Google Calendar]
        SF[Salesforce CRM]
    end
    
    U --> ID
    ID -->|subject_token| JAG
    JAG -->|assertion| AS
    
    AS -->|aud: apex-wealth-mcp| MCP
    AS -->|aud: auth0-vault| VA
    
    VA --> FED
    FED -->|google-oauth2| GC
    FED -->|salesforce| SF
        </div>
        <div class="note">
            <strong>Two Paths:</strong> Internal MCP uses Steps 1-3 only. External SaaS (Google, Salesforce) requires Steps 4-5 via Token Vault.
        </div>
    </div>

    <h2>2. MCP Flow - Detailed Sequence (Steps 1-3)</h2>
    <div class="diagram-container">
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant U as User Alice
    participant A as Apex Wealth
    participant O as Okta
    participant AS as Auth Server
    participant M as MCP Server

    rect rgb(239, 246, 255)
    Note over U,M: Step 1: User Authentication OIDC
    U->>O: GET /authorize client_id, redirect_uri, scope=openid
    O->>O: User authenticates SSO + MFA
    O->>A: Authorization code
    A->>O: POST /token code exchange
    O-->>A: ID Token + Access Token
    Note right of A: ID Token claims: sub=00usj80st46FcWThP1d7, <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="355058545c590854595c565075545658501b565a58">[email&#160;protected]</a>
    end

    rect rgb(250, 245, 255)
    Note over U,M: Step 2: Token Exchange RFC 8693
    A->>O: POST /oauth2/v1/token
    Note right of A: grant_type=token-exchange, subject_token=id_token, requested_token_type=id-jag
    O->>O: Validate ID Token signature
    O->>O: Check XAA policy for alice
    O-->>A: ID-JAG Token 5 min TTL
    Note right of A: ID-JAG: Okta vouches for user identity
    end

    rect rgb(240, 253, 244)
    Note over U,M: Step 3: JWT Bearer Grant RFC 7523
    A->>AS: POST /oauth2/aust6u013gCoEB6sz1d7/v1/token
    Note right of A: grant_type=jwt-bearer, assertion=id_jag, scope=mcp:read mcp:write
    AS->>AS: Validate ID-JAG signature
    AS-->>A: Access Token aud=apex-wealth-mcp
    end

    rect rgb(236, 253, 245)
    Note over U,M: MCP Tool Calls with user context
    A->>M: GET /tools/portfolio Authorization: Bearer token
    M->>M: Validate token, extract sub claim
    M-->>A: Portfolio data for <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="86e7eaefe5e3c6e7e5ebe3a8e5e9eb">[email&#160;protected]</a> only
    end
        </div>
        <div class="key-point">
            <strong>Security Guarantee:</strong> User identity (<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3a5b5653595f7a5b59575f14595557">[email&#160;protected]</a>) is cryptographically bound at every step. MCP server can ONLY return data for the authenticated user.
        </div>
    </div>

    <h2>3. Token Vault Flow - Detailed Sequence (Steps 4-5)</h2>
    <div class="diagram-container">
        <div class="mermaid">
sequenceDiagram
    autonumber
    participant A as Apex Wealth
    participant O as Okta Auth Server
    participant V as Auth0 Token Vault
    participant G as Google Calendar API

    rect rgb(253, 244, 255)
    Note over A,G: Step 4: Vault Token Exchange
    A->>O: POST /oauth2/v1/token
    Note right of A: grant_type=token-exchange, subject_token=auth_server_token, audience=auth0-vault
    O->>V: Federated token exchange
    V->>V: Validate incoming token
    V-->>O: Vault Access Token
    O-->>A: Vault Access Token virtual credential
    Note right of A: This grants vault access for alice, NOT Google access
    end

    rect rgb(253, 242, 248)
    Note over A,G: Step 5: Federated Token Retrieval
    A->>V: POST /api/v1/token-vault/tokens
    Note right of A: Authorization: Bearer vault_token, connection_id=google-oauth2
    V->>V: Extract user_id alice from token
    V->>V: Lookup alice Google connection
    V->>V: Retrieve stored refresh token
    V->>G: POST /oauth2/v4/token refresh
    G-->>V: Fresh access token 1hr TTL
    V-->>A: Google access token short-lived
    end

    rect rgb(236, 253, 245)
    Note over A,G: API Call to External Service
    A->>G: GET /calendar/v3/calendars/primary/events
    G-->>A: Alice calendar events
    Note right of A: Token expires in minutes, no long-term storage
    end
        </div>
        <div class="key-point">
            <strong>Critical Security:</strong> Agent NEVER stores Google credentials. The real refresh token lives only in Auth0 Token Vault. Agent receives short-lived tokens that expire in minutes.
        </div>
    </div>

    <h2>4. Key Endpoints Reference</h2>
    <div class="diagram-container">
        <table>
            <tr>
                <th>Step</th>
                <th>Endpoint</th>
                <th>Grant Type</th>
                <th>RFC</th>
            </tr>
            <tr>
                <td>1. OIDC Login</td>
                <td><code>/oauth2/v1/authorize</code></td>
                <td>authorization_code</td>
                <td>OpenID Connect</td>
            </tr>
            <tr>
                <td>2. Token Exchange</td>
                <td><code>/oauth2/v1/token</code></td>
                <td>urn:ietf:params:oauth:grant-type:token-exchange</td>
                <td>RFC 8693</td>
            </tr>
            <tr>
                <td>3. JWT Bearer</td>
                <td><code>/oauth2/{authServerId}/v1/token</code></td>
                <td>urn:ietf:params:oauth:grant-type:jwt-bearer</td>
                <td>RFC 7523</td>
            </tr>
            <tr>
                <td>4. Vault Exchange</td>
                <td><code>/oauth2/v1/token</code></td>
                <td>urn:ietf:params:oauth:grant-type:token-exchange</td>
                <td>Custom (Auth0 CTE)</td>
            </tr>
            <tr>
                <td>5. Federated Token</td>
                <td><code>/api/v1/token-vault/tokens</code></td>
                <td>Auth0 Token Vault API</td>
                <td>Auth0 Proprietary</td>
            </tr>
        </table>
    </div>

    <h2>5. Apex Wealth Okta Configuration</h2>
    <div class="diagram-container">
        <table>
            <tr>
                <th>Setting</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>Agent ID</td>
                <td><code>wlpt6vqrvo3HfiGZu1d7</code></td>
            </tr>
            <tr>
                <td>MCP Auth Server ID</td>
                <td><code>aust6u013gCoEB6sz1d7</code></td>
            </tr>
            <tr>
                <td>Frontend App ID</td>
                <td><code>0oat6ufu2xIOByfO11d7</code></td>
            </tr>
            <tr>
                <td>Audience</td>
                <td><code>apex-wealth-mcp</code></td>
            </tr>
            <tr>
                <td>Scopes</td>
                <td><code>mcp:read</code>, <code>mcp:write</code>, <code>mcp:payment</code></td>
            </tr>
        </table>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#eff6ff',
                primaryTextColor: '#1e40af',
                primaryBorderColor: '#3b82f6',
                lineColor: '#64748b',
                secondaryColor: '#f8fafc',
                tertiaryColor: '#ffffff',
                background: '#ffffff',
                mainBkg: '#ffffff',
                noteBkgColor: '#fef3c7',
                noteTextColor: '#92400e',
                noteBorderColor: '#fcd34d',
                act